<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Debugger - Sala do Futuro</title>
    <style>
        body { font-family: monospace; background-color: #121212; color: #e0e0e0; padding: 20px; }
        .container { max-width: 90%; margin: auto; }
        .step { background-color: #1e1e1e; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #03dac6; }
        .step h2 { margin-top: 0; color: #03dac6; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .hidden { display: none; }
        input { width: 100%; padding: 10px; border: 1px solid #444; border-radius: 4px; background-color: #333; color: #e0e0e0; box-sizing: border-box; margin-bottom: 10px;}
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; background-color: #03dac6; color: #121212; font-size: 16px; font-weight: bold; cursor: pointer; }
        pre { background-color: #000; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow-y: auto; }
        #essayList { list-style: none; padding: 0; }
        #essayList li { background-color: #2c2c2c; padding: 10px; margin-bottom: 5px; border-radius: 4px; cursor: pointer; }
        #essayList li:hover { background-color: #444; }
        p.status { text-align: center; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Super Debugger - Fluxo Completo</h1>

        <div class="step" id="login-step">
            <h2>Passo 1: Login</h2>
            <form id="loginForm">
                <input type="text" id="ra" placeholder="RA (com dígito e UF)" required>
                <input type="password" id="senha" placeholder="Senha" required>
                <button type="submit">Executar Login</button>
            </form>
        </div>

        <div class="step hidden" id="login-response-step">
            <h2>Passo 2: Resposta Completa do Login</h2>
            <p class="status" id="login-status"></p>
            <pre id="login-output">Aguardando login...</pre>
        </div>

        <div class="step hidden" id="selection-step">
            <h2>Passo 3: Selecione a Redação para ver a "Prévia"</h2>
            <ul id="essayList"></ul>
        </div>

        <div class="step hidden" id="details-response-step">
            <h2>Passo 4: Resposta Completa da "Prévia" (Texto de Apoio)</h2>
            <p class="status" id="details-status"></p>
            <pre id="details-output">Aguardando seleção de redação...</pre>
        </div>
    </div>

    <script>
        let tokenB = null;
        let allTasks = [];

        const loginForm = document.getElementById('loginForm');
        const loginResponseStep = document.getElementById('login-response-step');
        const loginStatus = document.getElementById('login-status');
        const loginOutput = document.getElementById('login-output');
        const selectionStep = document.getElementById('selection-step');
        const essayList = document.getElementById('essayList');
        const detailsResponseStep = document.getElementById('details-response-step');
        const detailsStatus = document.getElementById('details-status');
        const detailsOutput = document.getElementById('details-output');

        // Evento do formulário de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginStatus.textContent = "Logando...";
            loginResponseStep.classList.remove('hidden');

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user: e.target.ra.value, senha: e.target.senha.value })
                });
                const data = await res.json();
                loginOutput.textContent = JSON.stringify(data, null, 2); // MOSTRA A RESPOSTA COMPLETA DO LOGIN

                if (!res.ok) throw new Error(data.error);

                loginStatus.textContent = "Login bem-sucedido! ✅";
                tokenB = data.tokenB;
                allTasks = data.tarefas;

                // Mostra a lista de redações
                const pendingEssays = allTasks.filter(t => t.is_essay === true && t.answer_status !== 'pending');
                if (pendingEssays.length > 0) {
                    essayList.innerHTML = pendingEssays.map(essay => `<li data-task-id="${essay.id}">${essay.title}</li>`).join('');
                    document.querySelectorAll('#essayList li').forEach(li => li.addEventListener('click', getEssayDetails));
                    selectionStep.classList.remove('hidden');
                } else {
                    selectionStep.classList.remove('hidden');
                    essayList.innerHTML = '<li>Nenhuma redação pendente encontrada.</li>';
                }

            } catch (err) {
                loginStatus.textContent = `Falha no Login: ${err.message} ❌`;
                loginOutput.textContent = err.message;
            }
        });

        // Evento de clique na redação para buscar os detalhes
        async function getEssayDetails(event) {
            const taskId = event.currentTarget.dataset.taskId;
            detailsStatus.textContent = "Buscando detalhes da prévia...";
            detailsResponseStep.classList.remove('hidden');
            detailsOutput.textContent = '';


            // Pega os dados completos da tarefa que já temos
            const taskData = allTasks.find(t => t.id == taskId);
            const answerId = taskData.answer_id;
            const publicationTarget = taskData.publication_target;
            
            try {
                const res = await fetch('/api/get-essay-details', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ tokenB, taskId, answerId, publicationTarget }) 
                });
                const details = await res.json();
                detailsOutput.textContent = JSON.stringify(details, null, 2); // MOSTRA A RESPOSTA COMPLETA DA PRÉVIA

                if (!res.ok) throw new Error(details.error || 'Não foi possível carregar os detalhes.');
                detailsStatus.textContent = "Resposta da prévia recebida com sucesso! ✅";

            } catch (err) {
                detailsStatus.textContent = `Falha ao buscar detalhes: ${err.message} ❌`;
                detailsOutput.textContent = err.message;
            }
        }
    </script>
</body>
</html>
